# å£èªªç·´ç¿’ï¼ˆShadowingï¼‰å®Œæ•´æµç¨‹

å¾ä½¿ç”¨è€…é»é¸å£èªªç·´ç¿’ï¼Œåˆ° AI å›å‚³ shadowing èªéŸ³çš„å…¨éç¨‹ã€‚

---

## ä¸€ã€é€²å…¥å£èªªç·´ç¿’æ¨¡å¼

ä½¿ç”¨è€…å¯é€éå…©ç¨®æ–¹å¼åˆ‡æ›è‡³å£èªªç·´ç¿’ï¼š

| æ–¹å¼ | è§¸ç™¼ | è™•ç†é‚è¼¯ |
|------|------|----------|
| **Rich Menu** | é»é¸ã€Œå£èªªç·´ç¿’ã€æŒ‰éˆ• | `handle_postback` æ”¶åˆ° `data=mode=speaking` |
| **æ–‡å­—æŒ‡ä»¤** | è¼¸å…¥ã€Œå£èªªç·´ç¿’ã€ | `handle_message` åˆ¤æ–· `user_text == "å£èªªç·´ç¿’"` |

**å…±é€šå‹•ä½œï¼š**
1. `_set_cached_mode(user_id, "speaking")` å¯«å…¥æœ¬åœ°å¿«å–
2. `redis.set(user_mode:{user_id}, "speaking")` å¯«å…¥ Redis
3. å›è¦†ï¼šã€Œå·²åˆ‡æ›è‡³ã€ğŸ—£ï¸ å£èªªç·´ç¿’ã€‘æ¨¡å¼ï¼Œå¯å‚³é€èªéŸ³æˆ–æ–‡å­—ã€‚ã€

---

## äºŒã€ä½¿ç”¨è€…å‚³é€èªéŸ³

### 2.1 Webhook è§¸ç™¼ `handle_audio`

ç•¶ä½¿ç”¨è€…å‚³é€**èªéŸ³è¨Šæ¯**ï¼ˆ`AudioMessage`ï¼‰æ™‚ï¼š

```
LINE Platform â†’ POST /callback (Webhook) â†’ handle_audio(event)
```

**Webhook å¿…é ˆåœ¨ç´„ 2 ç§’å…§å›å‚³ 200**ï¼Œå› æ­¤æ¡å–éåŒæ­¥è¨­è¨ˆã€‚

### 2.2  immediate replyï¼ˆç«‹å³å›è¦†ï¼‰

```python
line_bot_api.reply_message(event.reply_token, TextSendMessage(text="ğŸ™ï¸ æ­£åœ¨è½‰æ›èªéŸ³..."))
```

- ä½¿ç”¨ `reply_token` å›è¦†
- è¨Šæ¯ï¼šã€ŒğŸ™ï¸ æ­£åœ¨è½‰æ›èªéŸ³...ã€
- ç›®çš„ï¼šåœ¨è™•ç†å®Œæˆå‰å…ˆå›è¦† LINEï¼Œé¿å…é€¾æ™‚

### 2.3 è§¸ç™¼èƒŒæ™¯ä»»å‹™

ä¾ç’°å¢ƒä¸åŒï¼š

| ç’°å¢ƒ | ä½œæ³• |
|------|------|
| **Vercel**ï¼ˆæœ‰ `VERCEL_URL` èˆ‡ `CRON_SECRET`ï¼‰ | `requests.post(base_url/api/process-voice-async, ...)`ï¼Œtimeout=0.8sï¼Œé€å‡ºå¾Œä¸ç­‰å¾…å®Œæˆ |
| **æœ¬æ©Ÿ** | `threading.Thread(target=_run_voice_background, ...).start()` |

`_run_voice_background` æœƒå‘¼å« `/api/process-voice-async`ï¼Œå‚³å…¥ `user_id` èˆ‡ `message_id`ã€‚

---

## ä¸‰ã€èƒŒæ™¯ä»»å‹™ï¼š`/api/process-voice-async`

æ­¤ç«¯é»ç”± `_process_voice_sync(user_id, message_id)` è² è²¬å¯¦éš›è™•ç†ã€‚

### 3.1 å–å¾—èªéŸ³æª”

1. `line_bot_api.get_message_content(message_id)` å–å¾—èªéŸ³å…§å®¹
2. æš«å­˜ç‚º `.m4a`ï¼ˆ`tempfile`ï¼‰
3. è‹¥å¯«å…¥å¤±æ•—ï¼Œæ”¹å­˜å°ˆæ¡ˆç›®éŒ„

### 3.2 Whisper èªéŸ³è¾¨è­˜

```python
transcript = client.audio.transcriptions.create(model="whisper-1", file=audio_file)
transcript_text = (transcript.text or "").strip()
```

- ä½¿ç”¨ OpenAI Whisper æ¨¡å‹
- ç”¢å‡ºè¾¨è­˜æ–‡å­—

### 3.3 å›å‚³è¾¨è­˜çµæœ

```python
line_bot_api.push_message(user_id, TextSendMessage(text=f"ğŸ¤ è¾¨è­˜å…§å®¹ï¼šã€Œ{transcript_text}ã€"))
```

### 3.4 ä¾æ¨¡å¼åˆ†æµ

å¾ Redis / å¿«å–è®€å– `mode = _safe_get_mode(user_id)`ï¼š

| mode | å¾ŒçºŒè™•ç† |
|------|----------|
| `writing` | `_revision_handler(user_id, transcript_text)`ï¼ˆå¯«ä½œä¿®è¨‚ï¼‰ |
| `speaking` | é€²å…¥å£èªªç·´ç¿’æµç¨‹ï¼ˆä¸‹æ–¹èªªæ˜ï¼‰ |
| `tcm` ç­‰ | èª²å‹™æŸ¥è©¢ / é›¢é¡Œåˆ¤æ–· / ä¸­é†«å•ç­”ç­‰ |

---

## å››ã€å£èªªç·´ç¿’æ¨¡å¼å°ˆå±¬æµç¨‹ï¼ˆ`mode == "speaking"`ï¼‰

### 4.1 GPT è©•ä¼°ï¼š`_evaluate_speech(transcript_text)`

- **æ¨¡å‹**ï¼š`gpt-4o-mini`
- **API**ï¼š`client.chat.completions.create`
- **ç”¨é€”**ï¼šåˆ†æèªæ³•ã€æ‹¼å¯«ã€ç”¨è©ã€èªç¾©
- **è¼¸å‡º**ï¼šJSON `{status, feedback, corrected}`
  - `status`ï¼š`"Correct"` æˆ– `"NeedsImprovement"`
  - `feedback`ï¼šç°¡çŸ­å›é¥‹
  - `corrected`ï¼šä¿®æ­£å¾Œæ–‡æœ¬ï¼ˆç”¨æ–¼ TTSï¼›Correct æ™‚ç‚ºç©ºï¼‰

### 4.2 è‹¥å®Œå…¨æ­£ç¢ºï¼ˆ`status == "Correct"`ï¼‰

```python
line_bot_api.push_message(user_id, text_with_quick_reply_speak_practice(
    "ç™¼éŸ³éå¸¸æ¨™æº–ï¼å¤ªæ£’äº†ï¼\n\nè¦å†ç·´ç¿’ä¸‹ä¸€å¥å—ï¼Ÿ"
))
```

- åƒ…å›è¦†æ–‡å­—ï¼Œä¸ç”¢ç”Ÿ TTS
- Quick Replyï¼šç·´ç¿’ä¸‹ä¸€å¥ã€çµæŸç·´ç¿’

### 4.3 è‹¥éœ€æ”¹é€²ï¼ˆ`status == "NeedsImprovement"`ï¼‰

**Step Aï¼šå…ˆæ¨æ–‡å­—å›é¥‹**

```python
text_for_tts = corrected_text if corrected_text else transcript_text
line_bot_api.push_message(user_id, text_with_quick_reply(
    f"ğŸ“Š å£èªªç·´ç¿’å›é¥‹\n\n{feedback}\n\nğŸ”Š è«‹è·Ÿè‘—å”¸ï¼šã€Œ{text_for_tts}ã€"
))
```

**Step Bï¼šTTS ç”¢ç”Ÿ Shadowing èªéŸ³**

```python
audio_url, duration_ms = _generate_tts_and_store(text_for_tts, voice=VOICE_COACH_TTS_VOICE)
```

`_generate_tts_and_store` æµç¨‹ï¼š

1. å‘¼å« `client.audio.speech.create`
   - `model="tts-1"`
   - `voice="shimmer"`ï¼ˆ`VOICE_COACH_TTS_VOICE`ï¼‰
   - `input=text_for_tts`
2. å–å¾— `audio_bytes = resp.content`
3. å„²å­˜èªéŸ³ï¼š
   - **å„ªå…ˆ**ï¼šä¸Šå‚³ Cloudinaryï¼ˆ`_upload_tts_to_cloudinary`ï¼‰ï¼Œå–å¾— HTTPS URL
   - **å‚™æ´**ï¼šBase64 å­˜å…¥ Redisï¼Œä½¿ç”¨ `/audio/<token>` å›å‚³

**Step Cï¼šæ¨é€èªéŸ³è¨Šæ¯**

```python
line_bot_api.push_message(user_id, AudioSendMessage(
    original_content_url=audio_url,
    duration=duration_ms
))
```

**Step Dï¼šæç¤ºç¹¼çºŒç·´ç¿’**

```python
line_bot_api.push_message(user_id, text_with_quick_reply_speak_practice(
    "ç¤ºç¯„èªéŸ³å·²é€ä¸Šï¼Œè¦å†ç·´ç¿’ä¸‹ä¸€å¥å—ï¼Ÿ"
))
```

è‹¥ TTS å¤±æ•—ï¼ˆ`audio_url` ç‚ºç©ºï¼‰ï¼Œå‰‡æ”¹æ¨æ–‡å­—ç‰ˆã€Œä¿®æ­£æ–‡æœ¬ï¼š...ã€ã€‚

---

## äº”ã€æµç¨‹åœ–ç¸½è¦½

```
ä½¿ç”¨è€…é»é¸ã€Œå£èªªç·´ç¿’ã€
    â†“
[Rich Menu Postback / æ–‡å­—ã€Œå£èªªç·´ç¿’ã€]
    â†“
è¨­å®š mode=speakingï¼ˆå¿«å– + Redisï¼‰
    â†“
å›è¦†ã€Œå·²åˆ‡æ›è‡³å£èªªç·´ç¿’æ¨¡å¼ã€
    â†“
ä½¿ç”¨è€…å‚³é€èªéŸ³
    â†“
handle_audio â†’ ç«‹å³å›è¦†ã€ŒğŸ™ï¸ æ­£åœ¨è½‰æ›èªéŸ³...ã€
    â†“
è§¸ç™¼ /api/process-voice-asyncï¼ˆPOSTï¼‰
    â†“
_process_voice_sync:
  1. å–å¾—èªéŸ³æª”
  2. Whisper è¾¨è­˜ â†’ transcript_text
  3. pushã€ŒğŸ¤ è¾¨è­˜å…§å®¹ï¼š...ã€
  4. è®€å– mode
  5. mode==speaking â†’
       _evaluate_speech(transcript) â†’ status, feedback, corrected_text
       â”œâ”€ Correct â†’ pushã€Œç™¼éŸ³éå¸¸æ¨™æº–ï¼å¤ªæ£’äº†ï¼ã€
       â””â”€ NeedsImprovement â†’
            push æ–‡å­—å›é¥‹ã€ŒğŸ“Š å£èªªç·´ç¿’å›é¥‹...ã€
            â†’ _generate_tts_and_store(corrected_text)
            â†’ push AudioSendMessageï¼ˆshadowing èªéŸ³ï¼‰
            â†’ pushã€Œç¤ºç¯„èªéŸ³å·²é€ä¸Šï¼Œè¦å†ç·´ç¿’ä¸‹ä¸€å¥å—ï¼Ÿã€
```

---

## å…­ã€ç›¸é—œç¨‹å¼ç¢¼ä½ç½®

| åŠŸèƒ½ | æª”æ¡ˆ | å‡½å¼/è·¯ç”± |
|------|------|-----------|
| é€²å…¥å£èªªæ¨¡å¼ï¼ˆPostbackï¼‰ | `api/index.py` | `handle_postback` |
| é€²å…¥å£èªªæ¨¡å¼ï¼ˆæ–‡å­—ï¼‰ | `api/index.py` | `handle_message`ï¼ˆ`user_text == "å£èªªç·´ç¿’"`ï¼‰ |
| èªéŸ³ Webhook | `api/index.py` | `handle_audio` |
| èƒŒæ™¯èªéŸ³è™•ç† | `api/index.py` | `_run_voice_background` |
| èªéŸ³è™•ç† API | `api/index.py` | `process_voice_async`ï¼ˆ`/api/process-voice-async`ï¼‰ |
| èªéŸ³è™•ç†æ ¸å¿ƒ | `api/index.py` | `_process_voice_sync` |
| GPT è©•ä¼° | `api/index.py` | `_evaluate_speech` |
| TTS ç”¢ç”Ÿèˆ‡å„²å­˜ | `api/index.py` | `_generate_tts_and_store` |
| Cloudinary ä¸Šå‚³ | `api/index.py` | `_upload_tts_to_cloudinary` |
| Redis éŸ³æª”è·¯ç”± | `api/index.py` | `serve_audio`ï¼ˆ`/audio/<token>`ï¼‰ |
